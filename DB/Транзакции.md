Блокировка - механизм, который сервер базы данных использует для управления одновременным использованием ресурсов данных. Большинство СУБД используют одну из следующих двух стартегий блокировки:
1. Записювающие информацию в базу данных должны запрашивать и получать от сервера блокировку записи для изменения данных, а исзвлекающие информацию из базы данных для выполнения запроса должны запрашивать и получать от сервера блокировку чтения. В то время как несколько пользователей могут читать данные одновременно, за один раз для каждой таблицы (или ее части) выдается тоько одна блокировка записи, а запросы на чтение блокируются до тех пор, пока блокировка записи не будет снята.
	1. Может привести к долгому ожиданию при наличии большого количества одновременных запросов на чтение и запись.
2. #Versioning(управление версиями). Писатели должны запрашивать и получать блокировку записи, но читателям не нужны никакие блокировки. Вместо этого сервер гарантирует, что каждый читатель с момента начала запроса видят согласованное представление данных, даже если они уже изменились, до тех пор, пока запрос не завершится. 
	1. Могут быть проблемы, если во время изменения данных поступают долгие запросы.
Microsoft SQL Server - первый подход
Oracle Database - второй подход
MySQL - оба (в зависимости от выбора)
PostgreSQL - хуй знает, см. почитать 2

Сервер может применять блокировку на одном из трех разных уровней:
	1. Блокировка таблиц - не позволяет нескольким пользователям одновременно изменять данные в одной таблице.
	2. Блокировка страниц - не позволяет нескольким пользователям изменять данные в одной странице (сегмент памяти, обычно в диапазоне от 2 до 16КБ) таблицы одновременно
	3. Блокировка строк - не позволяет одновременно изменять одну и то жу строку в таблице. Прикол: постгря, если в одной таблице заблокированно много строк, превратить их в одну общую блокировку таблиц.

#Транзакция - множество операций., которое переводит базу данных из одного корректного состояния в дургое корректное состояние (согласованность) при условии, что транзакция выполнена полностью (атомарность) и без помех со стороны других транзакций (изоляция)

В стандарте SQL есть 4 уровня изоляции транзакций:
1. Read uncommitted (чтение незафиксированных данных)
2. Read committed (чтение зафиксированных данных)
3. Repeatable read (повторяемое чтение)
4. Serializable (сериализуемость) 

Аномалии:
1. Потерянное обновление - аномалия возникает, когда две транзакции читают одну и ту же строку таблицы, затем одна транзакция обновляет эту строку, а после этого вторая транзакция тоже обновляет ту же строку, не учитывая изменений, сделанных первой транзакцией. 
2. Грязное чтение - такая аномалия возникает, когда транзакция читает еще не зафиксированные изменения, сделанные другой транзакцией.
3. Неповторяющееся чтение - возникает, когда транзакция читает одну и ту же строку два раза, и в промежутке между чтениями вторая транзакция изменяет (или удаляет) эту строку и фиксирует изменения. Тогда первая транзакция получит разные результаты
4. Фантомное чтение - возникает, когда транзакция два раза читает набор строк по одному и тому же условию, и в промежутке между чтениями вторая транзакция добавляет строки, удовлетворяющие этому условию, и фиксирует их. Тогда первая транзакция получит разные наборы строк. 


|                     | потерянные <br>изменения | грязное<br>чтение | неповторяющееся<br>чтение | фантомное <br>чтение | другие<br>аномалии |
| ------------------- | ------------------------ | ----------------- | ------------------------- | -------------------- | ------------------ |
| Read<br>Uncommitted | -                        | да                | да                        | да                   | да                 |
| Read <br>Committed  | -                        | -                 | да                        | да                   | да                 |
| Repeatable<br>Read  | -                        | -                 | -                         | да                   | да                 |
| Serializable        | -                        | -                 | -                         | -                    | -                  |

В PostgreSQL используется протокол изоляции на основе снимков (Snapshot Isolation). Такая изоляция автоматически не допускает грязное чтение. Формально можно указать уровень Read Uncommitted, но работать будет как Read Committed
Также у постгри реализаван многоверсионный вариант протокала, т.е. в одновременно могут сосуществовать несколько версий одной и той же строки. Это позволяет строить снимок данных, используя имеющиеся версии, и обходиться минимумом блокировок. Фактически блокируется только повторное изменение одной и той же строки. Все остальные операции выполняются одновременно.

За счет исопльзования снимков данных изоляция в постгру получается строже стандарта, уровень Repeatable Read не допускает не только неповторяющегося, но и фантомного чтения.
 
#ACID 
**Atomicity** (атомарность) - транзакция должна быть выполнена в целом или не выполнена вовсе.

**Consistency** (согласованность) - гарантирует, что по мере выполнения транзакций, данные переходят из одного согласованного состояния в другое, то есть транзакция не может разрушить взаимной согласованности данных.

**Isolation** (изолированность) - локализация пользовательских процессов означает, что конкурирующий за доступ к БД транзакции физически обрабатываются последовательно, изолированно друг от друга, но для пользователей это выглядит, как будто они выполняются параллельно

**Durability** (долговечность) - устойчивость к ошибкам - если транзакция завершена успешно, то те изменения в даннных, который были ею произведены, не могут быть потеряны ни при каких обстоятельствах.



Что еще почитать:
1. https://postgrespro.ru/docs/postgrespro/16/explicit-locking
2. https://habr.com/ru/companies/postgrespro/articles/462877/
3. https://habr.com/ru/companies/postgrespro/articles/442804/
4. https://habr.com/ru/companies/infopulse/articles/261097/
